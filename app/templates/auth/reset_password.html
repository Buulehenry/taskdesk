{% extends 'base.html' %} {% block content %} {# Reset Password page (WTForms) Expects: form=ResetPasswordForm Server: URL contains the signed token (/reset-password/
<token>) POST accepts `password` + `password2` and validates token server-side #}

    <div class="row g-4 align-items-stretch">
        <div class="col-lg-7 col-xl-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">Set a new password</h3>
                        <div class="small text-muted">Choose a strong password you haven't used before on TaskDesk.</div>
                    </div>
                    <a class="small" href="{{ url_for('auth.login') }}">Back to sign in</a>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        {{ form.hidden_tag() }}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" for="pw">New password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    {{ form.password(class_='form-control', id='pw', minlength=8, required=True, aria_describedby='pwHelp') }}
                                    <button class="btn btn-outline-secondary" type="button" id="pwToggle" tabindex="-1">Show</button>
                                </div>
                                <div id="pwHelp" class="form-text">At least 8 characters; mix upper/lowercase, numbers, and symbols.</div>
                                <div class="progress progress-sm mt-2">
                                    <div id="pwBar" class="progress-bar" style="width:0%"></div>
                                </div>
                                <div id="pwMsg" class="small text-muted mt-1">Strength: â€”</div>
                                {% for e in form.password.errors %}
                                <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="pw2">Confirm new password <span class="text-danger">*</span></label> {{ form.password2(class_='form-control', id='pw2', required=True) }}
                                <div class="invalid-feedback">Passwords must match.</div>
                                {% for e in form.password2.errors %}
                                <div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-primary" type="submit">Update password</button>
                            <a class="btn btn-outline-secondary" href="{{ url_for('auth.login') }}">Cancel</a>
                        </div>

                        {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
                        <div class="mt-3">
                            {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }}" role="alert">{{ message }}</div>
                            {% endfor %}
                        </div>
                        {% endif %} {% endwith %}
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5 col-xl-4">
            <div class="position-sticky" style="top:1rem;">
                <div class="card mb-3">
                    <div class="card-header"><strong>Security advice</strong></div>
                    <div class="card-body small">
                        <ul class="mb-0">
                            <li>Use a unique password for TaskDesk.</li>
                            <li>Avoid dictionary words; add numbers & symbols.</li>
                            <li>Consider a password manager to keep it safe.</li>
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><strong>Token expired?</strong></div>
                    <div class="card-body small">
                        <div class="mb-2">If your reset link expired, request a new one.</div>
                        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('auth.forgot_password') }}">Request new link</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // Toggle visibility
            const pw = document.getElementById('pw');
            const pw2 = document.getElementById('pw2');
            const btn = document.getElementById('pwToggle');
            btn && btn.addEventListener('click', () => {
                const t = pw.getAttribute('type') === 'password' ? 'text' : 'password';
                pw.setAttribute('type', t);
                pw2.setAttribute('type', t);
                btn.textContent = (t === 'password') ? 'Show' : 'Hide';
            });

            // Strength meter
            const bar = document.getElementById('pwBar');
            const msg = document.getElementById('pwMsg');

            function score(s) {
                let p = 0;
                if (!s) return 0;
                const len = s.length;
                if (len >= 8) p += 25;
                if (len >= 12) p += 10;
                if (/[a-z]/.test(s)) p += 15;
                if (/[A-Z]/.test(s)) p += 15;
                if (/[0-9]/.test(s)) p += 15;
                if (/[^A-Za-z0-9]/.test(s)) p += 20;
                return Math.min(p, 100);
            }

            function color(p) {
                if (p < 30) return 'bg-danger';
                if (p < 60) return 'bg-warning';
                if (p < 85) return 'bg-info';
                return 'bg-success';
            }

            function label(p) {
                if (p < 30) return 'Weak';
                if (p < 60) return 'Okay';
                if (p < 85) return 'Good';
                return 'Strong';
            }

            function update() {
                const v = pw.value || '';
                const p = score(v);
                bar.style.width = p + '%';
                bar.className = 'progress-bar ' + color(p);
                msg.textContent = 'Strength: ' + label(p);
            }
            pw && pw.addEventListener('input', update);
            update();

            // Validation + match check
            const form = document.querySelector('form.needs-validation');
            form && form.addEventListener('submit', (e) => {
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                if (pw && pw2 && pw.value !== pw2.value) {
                    e.preventDefault();
                    e.stopPropagation();
                    pw2.setCustomValidity('Mismatch');
                } else {
                    pw2.setCustomValidity('');
                }
                form.classList.add('was-validated');
            });
        })();
    </script>

    {% endblock %}