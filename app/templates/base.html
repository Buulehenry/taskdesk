<!doctype html>
<html lang="{{ get_locale() or 'en' }}" data-bs-theme="light">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ title or 'TaskDesk' }}</title>
        <meta name="csrf-token" content="{{ csrf_token() }}">
        <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/home.css') }}" rel="stylesheet"> {% block extra_css %}{% endblock %}

        <style>
            /* Layout */
            
            body {
                min-height: 100vh;
                display: flex;
                flex-direction: column
            }
            
            .container-main {
                flex: 1 0 auto
            }
            
            .footer {
                flex-shrink: 0
            }
            
            .btn-ghost {
                background: transparent;
                border: 1px solid var(--bs-border-color)
            }
            
            .toast-container {
                z-index: 1080
            }
            /* Logo: override Bootstrap's 2rem cap */
            /* Sizing (no display property here) */
            /* Keep Bootstrap navbar height */
            /* ===== Navbar polish ===== */
            /* === Big visual logo without growing the bar ===
   - Keep Bootstrap navbar height ~56px
   - Let the image visually exceed using negative margins
   - Tweak sizes per breakpoint via variables
*/
            
            .navbar-pro {
                /* Visual height you want to *see* (mobile) */
                --brand-visual-h: 64px;
                /* try 64–84px */
                --brand-base-h: 32px;
                /* the "inside" bar height we align to */
                --brand-offset: calc((var(--brand-visual-h) - var(--brand-base-h)) / 2);
                overflow: visible;
                /* allow visual overflow */
            }
            
            @media (min-width: 992px) {
                .navbar-pro {
                    /* Larger on desktop if you want */
                    --brand-visual-h: 80px;
                    /* try 72–96px */
                    --brand-base-h: 36px;
                    /* slightly taller baseline on lg+ */
                    --brand-offset: calc((var(--brand-visual-h) - var(--brand-base-h)) / 2);
                }
            }
            
            .navbar-pro .navbar-brand {
                padding-top: .25rem;
                padding-bottom: .25rem;
            }
            /* Apply the visual height + negative margins */
            
            .navbar-pro .brand-mark {
                height: var(--brand-visual-h);
                width: auto;
                display: block;
                margin-top: calc(-1 * var(--brand-offset));
                margin-bottom: calc(-1 * var(--brand-offset));
            }
            /* Keep wordmark aligned */
            
            .navbar-pro .brand-wordmark {
                line-height: var(--brand-base-h);
            }
            /* Keep light/dark swap from earlier */
            
            .navbar .logo-light {
                display: block;
            }
            
            .navbar .logo-dark {
                display: none;
            }
            
            [data-bs-theme="dark"] .navbar .logo-light {
                display: none;
            }
            
            [data-bs-theme="dark"] .navbar .logo-dark {
                display: block;
            }
            /* Links */
            
            .navbar-pro .nav-link {
                color: var(--td-nav-link-color);
                padding: .5rem .75rem;
                border-radius: .5rem;
                transition: color .15s ease, background-color .15s ease;
            }
            
            .navbar-pro .nav-link:hover,
            .navbar-pro .nav-link:focus {
                color: var(--td-nav-link-hover);
                background-color: var(--td-nav-active-bg);
                text-decoration: none;
            }
            /* Toggler */
            
            .navbar-pro .navbar-toggler {
                border: 1px solid var(--bs-border-color);
                padding: .35rem .5rem;
                border-radius: .6rem;
            }
            /* Icon-only button (theme toggle) */
            
            .btn-icon {
                width: 34px;
                height: 34px;
                display: inline-grid;
                place-items: center;
                border-radius: .6rem;
                padding: 0;
            }
            /* Dropdown */
            
            .navbar-pro .dropdown-menu {
                border-radius: .75rem;
                border: 1px solid var(--bs-border-color);
            }
            /* Small shadow when page scrolls */
            
            .navbar-pro.nav-scrolled {
                box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .06);
            }
            /* Optional: underline animation for active page (if you add .active manually) */
            
            .navbar-pro .nav-link.active {
                color: var(--td-nav-link-hover);
                background-color: var(--td-nav-active-bg);
            }
            /* Reduce giant inline logo overrides you had earlier */
            
            .navbar .navbar-brand img.brand-logo {
                height: 32px;
                margin: 0;
            }
            
            @media (min-width: 992px) {
                .navbar .navbar-brand img.brand-logo {
                    height: 36px;
                }
            }
            /* Footer bits */
            
            .footer a {
                text-decoration: none
            }
            
            .footer a:hover {
                text-decoration: underline
            }
            
            .footer .brand-badge {
                font-weight: 700;
                letter-spacing: .2px
            }
            
            .footer .social a {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--bs-border-color)
            }
            
            .footer .badge-pay {
                border: 1px solid var(--bs-border-color);
                padding: .35rem .5rem;
                border-radius: .5rem;
                font-size: .75rem
            }
            
            .footer .newsletter .form-control {
                max-width: 280px
            }
            /* Aggregate star display */
            
            .stars .star {
                color: #f59e0b
            }
            
            .stars .star.off {
                color: var(--bs-border-color)
            }
            
            .stars .star.half {
                position: relative;
                color: var(--bs-border-color)
            }
            
            .stars .star.half::before {
                content: "★";
                position: absolute;
                left: 0;
                top: 0;
                width: 50%;
                overflow: hidden;
                color: #f59e0b
            }
            /* Input star widget (rate modal) */
            
            .star-rating {
                --star-size: 24px;
                --star-gap: .35rem;
                --star-fill: #f59e0b;
                --star-muted: var(--bs-border-color);
                --star-bg: transparent;
                display: inline-flex;
                flex-direction: row-reverse;
                gap: var(--star-gap)
            }
            
            .star-rating input {
                position: absolute;
                left: -9999px
            }
            
            .star-rating label {
                display: inline-grid;
                place-items: center;
                width: calc(var(--star-size)*1.4);
                height: calc(var(--star-size)*1.2);
                border: 1px solid var(--bs-border-color);
                border-radius: .5rem;
                cursor: pointer;
                background: var(--star-bg);
                transition: background-color .15s, border-color .15s, transform .08s;
                user-select: none
            }
            
            .star-rating label svg {
                width: var(--star-size);
                height: var(--star-size);
                fill: var(--star-muted);
                transition: fill .15s
            }
            
            .star-rating label:hover svg,
            .star-rating label:hover~label svg {
                fill: var(--star-fill)
            }
            
            .star-rating input:checked~label svg {
                fill: var(--star-fill)
            }
            
            .star-rating label:active {
                transform: scale(.98)
            }
            /* Optional mobile-sized brand image baseline */
            
            .brand-logo {
                height: 36px;
                width: auto;
                display: block
            }
        </style>

        {% if cookie_consent.analytics %}
        <!-- Example analytics (guarded by consent). Replace with your provider. -->
        <script defer data-domain="taskdesk.example" src="https://plausible.io/js/script.js"></script>
        {% endif %}
    </head>

    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-pro bg-body-tertiary border-bottom">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center gap-2" href="/">
                    <!-- Light -->
                    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="TaskDesk" class="brand-mark logo-light" width="120" height="32">
                    <!-- Dark -->
                    <img src="{{ url_for('static', filename='img/logo-dark.png') }}" alt="TaskDesk" class="brand-mark logo-dark" width="120" height="32">

                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav" aria-controls="topnav" aria-expanded="false" aria-label="{{ _('Toggle navigation') }}">
      <span class="navbar-toggler-icon"></span>
    </button>

                <div class="collapse navbar-collapse" id="topnav">
                    <!-- Left -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        {% if current_user.is_authenticated %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('client.dashboard') }}">{{ _('Client') }}</a></li>
                        {% if current_user.role == 'freelancer' %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('freelancer.dashboard') }}">{{ _('Freelancer') }}</a></li>
                        {% endif %} {% if current_user.role == 'admin' %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.inbox') }}">{{ _('Admin') }}</a></li>
                        {% endif %} {% endif %}
                    </ul>

                    <!-- Right -->
                    <ul class="navbar-nav ms-auto align-items-lg-center">
                        <li class="nav-item me-lg-2">
                            <button id="themeToggle" class="btn btn-icon btn-ghost btn-sm" type="button" title="{{ _('Toggle theme') }}" aria-label="{{ _('Toggle theme') }}">
            <span class="icon-moon d-inline d-dark-none">🌙</span>
            <span class="icon-sun d-none d-dark-inline">☀️</span>
          </button>
                        </li>

                        {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              {{ current_user.name or _('Account') }}
            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm rounded-3">
                                <li><a class="dropdown-item" href="{{ url_for('client.dashboard') }}">{{ _('Dashboard') }}</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">{{ _('Logout') }}</a></li>
                            </ul>
                        </li>
                        {% else %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.login') }}">{{ _('Login') }}</a></li>
                        <li class="nav-item"><a class="btn btn-primary ms-lg-2" href="{{ url_for('auth.register') }}">{{ _('Create account') }}</a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>


        <!-- Main -->
        <div class="container container-main py-3">
            {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
            <div class="toast-container position-fixed top-0 end-0 p-3">
                {% for category, message in messages %}
                <div class="toast align-items-center text-bg-{{ 'primary' if category in ['message','primary','info'] else category }} border-0 show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">{{ message }}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{{ _('Close') }}"></button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %} {% endwith %} {% block content %}{% endblock %}
        </div>

        <!-- Footer -->
        <footer class="footer bg-body-tertiary border-top">
            <!-- CTA strip -->
            <div class="py-3 border-bottom">
                <div class="container d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <span class="brand-badge">{{ _('TaskDesk') }}</span>
                        <span class="text-muted">{{ _("Need a hand? Our team’s here to help.") }}</span>
                    </div>
                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.support') }}">{{ _("Contact Support") }}</a>
                        <a class="btn btn-primary btn-sm" href="{{ url_for('auth.register') }}">{{ _("Get Started") }}</a>
                    </div>
                </div>
            </div>

            <!-- Main footer content -->
            <div class="container py-4">
                <div class="row g-4">
                    <!-- Col 1 -->
                    <div class="col-12 col-lg-4">
                        <div class="mb-2 brand-badge">{{ _('TaskDesk') }}</div>
                        <p class="text-muted mb-3">
                            {{ _("We help busy professionals hit their deadlines—submit a task, we deliver or assign the right expert fast.") }}
                        </p>

                        <div class="d-flex align-items-center gap-2 social mb-3">
                            <a href="#" aria-label="LinkedIn" title="LinkedIn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM.5 8h4V24h-4V8zm7.5 0h3.8v2.2h.05c.53-1 1.86-2.2 3.84-2.2 4.1 0 4.86 2.7 4.86 6.2V24h-4v-7.1c0-1.7-.03-3.9-2.4-3.9-2.4 0-2.77 1.9-2.77 3.8V24h-4V8z"/></svg>
                            </a>
                            <a href="#" aria-label="Twitter" title="Twitter">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.46 6c-.77.35-1.6.58-2.46.69a4.27 4.27 0 0 0 1.88-2.36 8.52 8.52 0 0 1-2.7 1.03 4.26 4.26 0 0 0-7.26 3.88A12.07 12.07 0 0 1 3.15 4.6a4.25 4.25 0 0 0 1.32 5.68 4.23 4.23 0 0 1-1.93-.53v.05a4.26 4.26 0 0 0 3.42 4.18 4.28 4.28 0 0 1-1.92.07 4.27 4.27 0 0 0 3.98 2.96A8.55 8.55 0 0 1 2 19.54a12.06 12.06 0 0 0 6.53 1.92c7.84 0 12.13-6.5 12.13-12.13 0-.18 0-.36-.01-.54A8.66 8.66 0 0 0 24 5.3a8.5 8.5 0 0 1-2.54.7z"/></svg>
                            </a>
                            <a href="mailto:support@taskdesk.ug" aria-label="{{ _('Email') }}" title="{{ _('Email') }}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 13 2 6.76V18h20V6.76L12 13zm0-2.4L22 4H2l10 6.6z"/></svg>
                            </a>
                        </div>

                        <!-- Subscribe button -->
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#subscribeModal">
              {{ _("Subscribe now") }}
            </button>

                        <!-- Subscribe Modal -->
                        <div class="modal fade" id="subscribeModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">{{ _("Subscribe to updates") }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
                                    </div>
                                    <form method="post" action="{{ url_for('main.subscribe_post') }}" class="newsletter">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="source" value="footer">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label" for="nl_email">{{ _("Email") }}</label>
                                                <input id="nl_email" name="email" type="email" class="form-control" placeholder="you@example.com" autocomplete="email" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label" for="nl_name">{{ _("Name (optional)") }}</label>
                                                <input id="nl_name" name="name" type="text" class="form-control" placeholder="{{ _('Your name') }}" autocomplete="name">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-primary" type="submit">{{ _("Subscribe") }}</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Col 2 -->
                    <div class="col-6 col-lg-2">
                        <div class="fw-semibold mb-2">{{ _("Product") }}</div>
                        <ul class="list-unstyled small">
                            <li class="mb-1"><a href="{{ url_for('client.dashboard') if current_user.is_authenticated else url_for('auth.register') }}">{{ _("For Clients") }}</a></li>
                            <li class="mb-1"><a href="{{ url_for('freelancer.dashboard') if current_user.is_authenticated else url_for('auth.register') }}">{{ _("For Freelancers") }}</a></li>
                            <li class="mb-1"><a href="{{ url_for('main.support') }}">{{ _("Help Center") }}</a></li>
                        </ul>
                    </div>

                    <!-- Col 3 -->
                    <div class="col-6 col-lg-2">
                        <div class="fw-semibold mb-2">{{ _("Company") }}</div>
                        <ul class="list-unstyled small">
                            <li class="mb-1"><a href="{{ url_for('main.about') }}">{{ _("About") }}</a></li>
                            <li class="mb-1"><a href="{{ url_for('main.careers') }}">{{ _("Careers") }}</a></li>
                            <li class="mb-1"><a href="{{ url_for('main.support') }}">{{ _("Contact") }}</a></li>
                        </ul>
                    </div>

                    <!-- Col 4 -->
                    <div class="col-6 col-lg-2">
                        <div class="fw-semibold mb-2">{{ _("Legal") }}</div>
                        <ul class="list-unstyled small">
                            <li class="mb-1"><a href="{{ url_for('main.privacy') }}">{{ _("Privacy") }}</a></li>
                            <li class="mb-1"><a href="{{ url_for('main.terms') }}">{{ _("Terms") }}</a></li>
                            <li class="mb-1"><a href="{{ url_for('main.cookies') }}">{{ _("Cookies") }}</a></li>
                        </ul>
                    </div>

                    <!-- Col 5 -->
                    <div class="col-6 col-lg-2">
                        <div class="fw-semibold mb-2">{{ _("Trust & Payments") }}</div>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="badge-pay">Pesapal</span>
                            <span class="badge-pay">Visa</span>
                            <span class="badge-pay">Mastercard</span>
                        </div>

                        <!-- Aggregate rating -->
                        <div class="rating text-muted small mb-2" itemprop="aggregateRating" itemscope itemtype="https://schema.org/AggregateRating">
                            <div class="mb-1">{{ _("Customer Rating") }}</div>
                            <div class="d-inline-flex align-items-center" aria-label="{{ _('Rated %(n)s out of 5', n=('%.1f'|format((rating_avg|default(0.0))))) }}">
                                <span class="stars" aria-hidden="true">
                  {% set avg = (rating_avg|default(0.0)) %}
                  {% set full = avg|int %}
                  {% set half = 1 if (avg - full) >= 0.25 and (avg - full) < 0.75 else 0 %}
                  {% set extra_full = 1 if (avg - full) >= 0.75 else 0 %}
                  {% set full_total = full + extra_full %}
                  {% for _ in range(0, full_total) %}<span class="star">★</span>{% endfor %} {% if half and not extra_full %}<span class="star half">★</span>{% endif %} {% set half_used = 1 if (half and not extra_full)
                                else 0 %} {% for _ in range(0, 5 - full_total - half_used) %}<span class="star off">★</span>{% endfor %}
                                </span>
                                <span class="ms-1">
                  <span class="fw-semibold">{{ '%.1f'|format(avg) }}</span>
                                <span class="text-body-tertiary">({{ rating_count|default(0) }})</span>
                                </span>
                            </div>
                            <meta itemprop="ratingValue" content="{{ '%.1f'|format(avg) }}">
                            <meta itemprop="bestRating" content="5">
                            <meta itemprop="ratingCount" content="{{ rating_count|default(0) }}">
                        </div>

                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#rateModal">
              ⭐ {{ _("Rate TaskDesk") }}
            </button>
                    </div>
                </div>

                <hr class="my-3">

                <!-- Bottom bar -->
                <div class="d-flex flex-wrap justify-content-between align-items-center small text-muted">
                    <div>© <span id="year"></span> {{ _("TaskDesk. All rights reserved.") }}</div>
                    <div class="d-flex gap-3">
                        <a href="{{ url_for('main.privacy') }}">{{ _("Privacy") }}</a>
                        <a href="{{ url_for('main.terms') }}">{{ _("Terms") }}</a>
                        <a href="{{ url_for('main.support') }}">{{ _("Support") }}</a>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Rate Modal -->
        <div class="modal fade" id="rateModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">⭐ {{ _("Rate TaskDesk") }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
                    </div>
                    <form method="post" action="{{ url_for('main.rating_post') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-body">
                            <label class="form-label small d-block mb-1">{{ _("Your rating") }}</label>
                            <div class="star-rating mb-3" role="radiogroup" aria-label="{{ _('Star rating') }}">
                                <input type="radio" name="stars" id="mstar5" value="5" checked><label for="mstar5" title="5"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.786 1.401 8.163L12 18.896l-7.335 3.864 1.401-8.163L.132 9.211l8.2-1.193L12 .587z"/></svg></label>
                                <input type="radio" name="stars" id="mstar4" value="4"><label for="mstar4" title="4"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.786 1.401 8.163L12 18.896l-7.335 3.864 1.401-8.163L.132 9.211l8.2-1.193L12 .587z"/></svg></label>
                                <input type="radio" name="stars" id="mstar3" value="3"><label for="mstar3" title="3"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.786 1.401 8.163L12 18.896l-7.335 3.864 1.401-8.163L.132 9.211l8.2-1.193L12 .587z"/></svg></label>
                                <input type="radio" name="stars" id="mstar2" value="2"><label for="mstar2" title="2"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.786 1.401 8.163L12 18.896l-7.335 3.864 1.401-8.163L.132 9.211l8.2-1.193L12 .587z"/></svg></label>
                                <input type="radio" name="stars" id="mstar1" value="1"><label for="mstar1" title="1"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.786 1.401 8.163L12 18.896l-7.335 3.864 1.401-8.163L.132 9.211l8.2-1.193L12 .587z"/></svg></label>
                            </div>

                            <label class="form-label small" for="m_comment">{{ _("Feedback (optional)") }}</label>
                            <textarea id="m_comment" name="comment" class="form-control" rows="4" maxlength="2000" placeholder="{{ _('Tell us what worked well or what to improve…') }}"></textarea> {% if not current_user.is_authenticated %}
                            <div class="row g-2 mt-2">
                                <div class="col-6"><input class="form-control form-control-sm" type="text" name="name" placeholder="{{ _('Name (optional)') }}"></div>
                                <div class="col-6"><input class="form-control form-control-sm" type="email" name="email" placeholder="{{ _('Email (optional)') }}" autocomplete="email"></div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary">{{ _("Submit feedback") }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Theme toggle
            (function() {
                const root = document.documentElement,
                    key = 'td.theme',
                    btn = document.getElementById('themeToggle');
                const saved = localStorage.getItem(key);
                if (saved) root.setAttribute('data-bs-theme', saved);

                function icons() {
                    const theme = root.getAttribute('data-bs-theme') || 'light';
                    if (!btn) return;
                    const moon = btn.querySelector('.d-dark-none'),
                        sun = btn.querySelector('.d-dark-inline');
                    if (theme === 'dark') {
                        moon.classList.add('d-none');
                        sun.classList.remove('d-none');
                    } else {
                        moon.classList.remove('d-none');
                        sun.classList.add('d-none');
                    }
                }
                btn && btn.addEventListener('click', () => {
                    const t = root.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
                    root.setAttribute('data-bs-theme', t);
                    localStorage.setItem(key, t);
                    icons();
                });
                icons();
            })();

            // Tooltips + year
            document.addEventListener('DOMContentLoaded', () => {
                [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(el => new bootstrap.Tooltip(el));
                const y = document.getElementById('year');
                if (y) y.textContent = new Date().getFullYear();
            });

            // Generic table bulk select
            document.querySelectorAll('table').forEach(table => {
                const selectAll = table.querySelector('#selectAll');
                const checks = table.querySelectorAll('.row-check');
                if (!selectAll || !checks.length) return;

                function sync() {
                    const n = [...checks].filter(c => c.checked).length;
                    const counter = document.getElementById('selCount');
                    if (counter) counter.textContent = n;
                    const ids = [...checks].filter(c => c.checked).map(c => c.value).join(',');
                    document.querySelectorAll('#bulkIds,#bulkIds2,#bulkIds3').forEach(i => i.value = ids);
                }
                selectAll.addEventListener('change', () => {
                    checks.forEach(c => c.checked = selectAll.checked);
                    sync();
                });
                checks.forEach(c => c.addEventListener('change', sync));
                sync();
            });

            // Inbox bulk forms: append task_ids[] before submit
            document.querySelectorAll('.bulk-form').forEach(form => {
                form.addEventListener('submit', (e) => {
                    const ids = [...document.querySelectorAll('#inboxTable .row-check:checked')].map(c => c.value);
                    if (!ids.length) {
                        e.preventDefault();
                        alert('{{ _("Select at least one task.") }}');
                        return;
                    }
                    ids.forEach(id => {
                        const i = document.createElement('input');
                        i.type = 'hidden';
                        i.name = 'task_ids';
                        i.value = id;
                        form.appendChild(i);
                    });
                });
            });
        </script>

        {% block extra_js %}{% endblock %} {% if should_show_cookie_banner %}
        <!-- Cookie banner -->
        <div class="position-fixed bottom-0 start-0 end-0 p-3" style="z-index:1090;">
            <div class="card shadow-lg border rounded-3 mx-auto" style="max-width:720px;">
                <div class="card-body d-flex flex-wrap align-items-center gap-3">
                    <div class="flex-grow-1">
                        <div class="fw-semibold mb-1">We use cookies</div>
                        <div class="small text-muted">
                            We use essential cookies to make TaskDesk work and optional analytics cookies to improve it. See our <a href="{{ url_for('main.cookies') }}">Cookies page</a>.
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <form method="post" action="{{ url_for('main.cookies_consent') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button class="btn btn-outline-secondary btn-sm" aria-controls="cookiePrefs">Reject all</button>
                        </form>
                        <form method="post" action="{{ url_for('main.cookies_consent') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="analytics" value="on">
                            <input type="hidden" name="marketing" value="on">
                            <button class="btn btn-primary btn-sm">Accept all</button>
                        </form>
                        <button class="btn btn-ghost btn-sm" data-bs-toggle="modal" data-bs-target="#cookiePrefs" aria-controls="cookiePrefs">Preferences</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Cookie preferences modal -->
        <div class="modal fade" id="cookiePrefs" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="post" action="{{ url_for('main.cookies_consent') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-header">
                            <h5 class="modal-title">Cookie preferences</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="cEssential" checked disabled>
                                <label class="form-check-label" for="cEssential">Essential cookies (required)</label>
                                <div class="form-text">Security, CSRF, session; cannot be turned off.</div>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="cAnalytics" name="analytics" {{ 'checked' if cookie_consent.analytics else '' }}>
                                <label class="form-check-label" for="cAnalytics">Analytics cookies</label>
                                <div class="form-text">Anonymous usage trends to help us improve TaskDesk.</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cMarketing" name="marketing" {{ 'checked' if cookie_consent.marketing else '' }}>
                                <label class="form-check-label" for="cMarketing">Marketing cookies</label>
                                <div class="form-text">Occasional campaigns and attribution.</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-outline-secondary" href="{{ url_for('main.cookies') }}">Learn more</a>
                            <button class="btn btn-primary">Save preferences</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script src="{{ url_for('static', filename='js/home.js') }}"></script>
        <script>
            (function() {
                const nav = document.querySelector('.navbar-pro');
                const collapseEl = document.getElementById('topnav');
                const bsCollapse = collapseEl ? new bootstrap.Collapse(collapseEl, {
                    toggle: false
                }) : null;

                function onScroll() {
                    if (!nav) return;
                    if (window.scrollY > 6) nav.classList.add('nav-scrolled');
                    else nav.classList.remove('nav-scrolled');
                }
                onScroll();
                window.addEventListener('scroll', onScroll, {
                    passive: true
                });

                // Auto close on nav-link click (mobile)
                if (collapseEl) {
                    collapseEl.querySelectorAll('.nav-link, .dropdown-item').forEach(a => {
                        a.addEventListener('click', () => {
                            if (window.getComputedStyle(collapseEl).display !== 'none') {
                                bsCollapse && bsCollapse.hide();
                            }
                        });
                    });
                }
            })();
        </script>



    </body>

</html>