{% extends 'base.html' %} {% set title = 'My Support Tickets — TaskDesk' %} {% block extra_css %}
<style>
    .tickets-hero {
        background: var(--bs-body-bg);
        border-bottom: 1px solid var(--bs-border-color)
    }
    
    .tickets-hero .lead {
        color: var(--bs-secondary-color)
    }
    
    .ticket-row:hover {
        background: rgba(0, 0, 0, .02)
    }
    
    .status-pill {
        min-width: 5.5rem;
        display: inline-block;
        text-transform: capitalize
    }
</style>
{% endblock %} {% block content %}
<section class="tickets-hero py-4">
    <div class="container">
        <h1 class="mb-1">My Support Tickets</h1>
        <p class="lead mb-0">View and track your TaskDesk support requests.</p>
    </div>
</section>

<div class="container my-4">
    {# Flash alerts #} {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
    <div class="mb-3">
        {% for category, msg in messages %}
        <div class="alert alert-{{ 'success' if category=='success' else ('danger' if category in ['danger','error'] else ('warning' if category=='warning' else 'info')) }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
        <form class="d-flex gap-2" method="get" action="{{ url_for('main.support_my') }}">
            <div>
                <label class="form-label small mb-1">Search</label>
                <input type="text" class="form-control" name="q" value="{{ request.args.get('q','') }}" placeholder="ID, category, status...">
            </div>
            <div>
                <label class="form-label small mb-1">Status</label>
                <select class="form-select" name="status">
          {% set s = request.args.get('status','') %}
          <option value="">Any</option>
          <option value="open" {{ 'selected' if s=='open' else '' }}>Open</option>
          <option value="pending" {{ 'selected' if s=='pending' else '' }}>Pending</option>
          <option value="closed" {{ 'selected' if s=='closed' else '' }}>Closed</option>
        </select>
            </div>
            <div>
                <button class="btn btn-primary" type="submit">Filter</button>
            </div>
        </form>
        <div class="ms-auto">
            <a class="btn btn-outline-secondary" href="{{ url_for('main.support') }}#contact">New Ticket</a>
        </div>
    </div>

    {% if tickets and tickets.items|length %}
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:12rem">Ticket</th>
                    <th style="width:10rem">Category</th>
                    <th style="width:8rem">Status</th>
                    <th style="width:14rem">Submitted</th>
                    <th>Summary</th>
                    <th style="width:9.5rem">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tickets.items %}
                <tr class="ticket-row">
                    <td class="text-muted">#{{ t.ticket_id }}</td>
                    <td>{{ t.category }}</td>
                    <td>
                        <span class="badge status-pill bg-{{ 'success' if t.status=='closed' else ('warning' if t.status=='pending' else 'primary') }}">{{ t.status }}</span>
                    </td>
                    <td>{{ t.created_at }}</td>
                    <td class="text-truncate" style="max-width:24rem">{{ t.message[:180] }}{% if t.message|length > 180 %}…{% endif %}</td>
                    <td class="d-flex gap-2">
                        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.support_thread', ticket_code=t.ticket_id) }}">
                            <i class="bi bi-chat-dots"></i> Chat
                        </a>
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#t{{ t.id }}">View</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pagination #} {% if tickets.pages > 1 %}
    <nav aria-label="My tickets pages" class="mt-2">
        <ul class="pagination pagination-sm">
            <li class="page-item {{ 'disabled' if not tickets.has_prev }}">
                <a class="page-link" href="{{ url_for('main.support_my', page=tickets.prev_num, q=request.args.get('q'), status=request.args.get('status')) }}">Prev</a>
            </li>
            <li class="page-item disabled"><span class="page-link">Page {{ tickets.page }} / {{ tickets.pages }}</span></li>
            <li class="page-item {{ 'disabled' if not tickets.has_next }}">
                <a class="page-link" href="{{ url_for('main.support_my', page=tickets.next_num, q=request.args.get('q'), status=request.args.get('status')) }}">Next</a>
            </li>
        </ul>
    </nav>
    {% endif %} {% else %}
    <div class="text-muted">No tickets found.</div>
    {% endif %}
</div>

{# Optional: Detail modals for quick view #} {% if tickets and tickets.items|length %} {% for t in tickets.items %}
<div class="modal fade" id="t{{ t.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ticket #{{ t.ticket_id }} — {{ t.category }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <span class="badge status-pill bg-{{ 'success' if t.status=='closed' else ('warning' if t.status=='pending' else 'primary') }}">{{ t.status }}</span>
                    </dd>
                    <dt class="col-sm-3">Submitted</dt>
                    <dd class="col-sm-9">{{ t.created_at }}</dd>
                    {% if t.updated_at %}
                    <dt class="col-sm-3">Updated</dt>
                    <dd class="col-sm-9">{{ t.updated_at }}</dd>
                    {% endif %}
                </dl>
                <hr>
                <h6>Message</h6>
                <p class="mb-3" style="white-space:pre-wrap">{{ t.message }}</p>
                {% if t.attachments and t.attachments|length %}
                <h6>Attachments</h6>
                <ul class="mb-0">
                    {% for a in t.attachments %}
                    <li>{{ a.filename }} <span class="text-muted">({{ a.size_bytes }} bytes)</span></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            <div class="modal-footer">
                <a class="btn btn-primary" href="{{ url_for('main.support_thread', ticket_code=t.ticket_id) }}">
            Open Chat
          </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %} {% endif %} {% endblock %}