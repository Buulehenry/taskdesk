{% extends 'base.html' %} {% from 'macros.html' import task_status_progress, progress_bar %} {% block content %} {# Context: assignments: List[Assignment] for current freelancer Each Assignment has: id, status, accept_expires_at, accepted_at, declined_at,
task (relationship) task fields used: id, title, category, status, deadline_at, created_at, work_submissions (if relationship added) Also available (optional): current_user.kyc_status #}

<div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h3 class="mb-2 mb-md-0">My Assignments</h3>
    <div class="d-flex flex-wrap gap-2 align-items-center">
        {# KYC status chip #} {% if current_user.kyc_status == 'approved' %}
        <span class="badge bg-success">KYC Approved</span> {% elif current_user.kyc_status == 'submitted' %}
        <span class="badge bg-warning text-dark">KYC In review</span> {% elif current_user.kyc_status == 'rejected' %}
        <span class="badge bg-danger">KYC Rejected</span> {% else %}
        <span class="badge bg-light text-dark">KYC Unverified</span> {% endif %}
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('freelancer.profile') }}">Edit Profile</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('freelancer.kyc') }}">Verify Identity</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('client.dashboard') }}">Client View</a>
    </div>
</div>

{# KPI Cards #} {% set total = assignments|length %} {% set pending = assignments|selectattr('status','equalto','pending')|list|length %} {% set accepted = assignments|selectattr('status','equalto','accepted')|list|length %} {% set declined = assignments|selectattr('status','equalto','declined')|list|length
%} {% set expired = assignments|selectattr('status','equalto','expired')|list|length %}

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Total</div>
                <div class="fs-4 fw-bold">{{ total }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Pending</div>
                <div class="fs-4 fw-bold">{{ pending }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Accepted</div>
                <div class="fs-4 fw-bold">{{ accepted }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Declined/Expired</div>
                <div class="fs-4 fw-bold">{{ declined + expired }}</div>
            </div>
        </div>
    </div>
</div>

{# KYC banner #} {% if current_user.kyc_status == 'approved' %}
<div class="alert alert-success d-flex justify-content-between align-items-center" role="alert">
    <div><strong>KYC verified.</strong></div>
    <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('freelancer.profile') }}">Update Profile</a>
        <a class="btn btn-sm btn-primary" href="{{ url_for('freelancer.kyc') }}">Update KYC</a>
    </div>
</div>
{% else %}
<div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
    <div>
        <strong>Boost your chances:</strong> complete identity verification to receive more assignments.
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('freelancer.profile') }}">Update Profile</a>
        <a class="btn btn-sm btn-primary" href="{{ url_for('freelancer.kyc') }}">Go to KYC</a>
    </div>
</div>
{% endif %}


<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <div class="input-group" style="max-width: 360px;">
                        <span class="input-group-text">Search</span>
                        <input id="search" type="text" class="form-control" placeholder="Task title or category…">
                    </div>
                    <select id="statusFilter" class="form-select" style="max-width: 220px;">
            <option value="">All statuses</option>
            <option>pending</option>
            <option>accepted</option>
            <option>declined</option>
            <option>expired</option>
            <option>revoked</option>
          </select>
                    <div class="ms-auto small text-muted">Showing <span id="visibleCount">{{ total }}</span> of {{ total }}</div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if assignments and assignments|length %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="assignmentsTable">
                        <thead class="table-light">
                            <tr>
                                <th class="text-nowrap">Assign #</th>
                                <th style="min-width: 240px;">Task</th>
                                <th>Task Status</th>
                                <th class="text-nowrap">Accept By</th>
                                <th class="text-nowrap">Countdown</th>
                                <th class="text-nowrap">Deadline</th>
                                <th class="text-nowrap">History</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in assignments %} {% set t = a.task %}
                            <tr data-title="{{ (t.title or '') ~ ' ' ~ (t.category or '') }}" data-status="{{ a.status }}">
                                <td class="text-muted">#{{ a.id }}</td>
                                <td>
                                    <div class="fw-semibold">{{ t.title }}</div>
                                    <div class="small text-muted">{{ t.category or '—' }} • Created {{ t.created_at }}</div>
                                </td>
                                <td style="min-width:200px">{{ task_status_progress(t.status) }}</td>
                                <td>
                                    {% if a.accept_expires_at %}
                                    <span class="badge bg-light text-dark">{{ a.accept_expires_at }}</span> {% else %}
                                    <span class="text-muted">—</span> {% endif %}
                                </td>
                                <td>
                                    {% if a.status == 'pending' and a.accept_expires_at %}
                                    <span class="badge bg-warning text-dark countdown" data-deadline="{{ a.accept_expires_at.isoformat() }}">—</span> {% elif a.status == 'accepted' %}
                                    <span class="badge bg-success">Accepted</span> {% elif a.status == 'declined' %}
                                    <span class="badge bg-secondary">Declined</span> {% elif a.status == 'expired' %}
                                    <span class="badge bg-dark">Expired</span> {% else %}
                                    <span class="text-muted">—</span> {% endif %}
                                </td>
                                <td>{{ t.deadline_at or '—' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#wsModal_{{ t.id }}">View</button>
                                </td>
                                <td class="text-end">
                                    {% if a.status == 'pending' %}
                                    <a class="btn btn-sm btn-success" href="{{ url_for('freelancer.assignment_accept', assignment_id=a.id) }}">Accept</a>
                                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('freelancer.assignment_decline', assignment_id=a.id) }}">Decline</a> {% elif a.status == 'accepted' %}
                                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('client.task_view', task_id=t.id) }}">Open Task</a>
                                    <a class="btn btn-sm btn-primary" href="{{ url_for('freelancer.submit_work', task_id=t.id) }}">Submit Work</a> {% else %}
                                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('client.task_view', task_id=t.id) }}">Open Task</a> {% endif %}
                                </td>
                            </tr>

                            {# Submission History Modal per task #}
                            <div class="modal fade" id="wsModal_{{ t.id }}" tabindex="-1" aria-labelledby="wsModalLabel_{{ t.id }}" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="wsModalLabel_{{ t.id }}">Submission History — Task #{{ t.id }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body p-0">
                                            <div class="list-group list-group-flush">
                                                {% set subs = t.work_submissions if t.work_submissions is defined else [] %} {% if subs and subs|length %} {% for ws in subs|sort(attribute='submitted_at', reverse=True) %}
                                                <div class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="fw-semibold">Version {{ ws.version or loop.revindex }} • {{ ws.submitted_at }}</div>
                                                        <span class="badge bg-light text-dark">by user #{{ ws.by_user_id }}</span>
                                                    </div>
                                                    {% if ws.comment %}
                                                    <div class="mt-1">{{ ws.comment }}</div>
                                                    {% endif %} {% if ws.files_json %}
                                                    <div class="small text-muted mt-1">Files: {{ ws.files_json }}</div>
                                                    {% endif %}
                                                </div>
                                                {% endfor %} {% else %}
                                                <div class="list-group-item text-muted">No submissions yet for this task.</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <a class="btn btn-primary" href="{{ url_for('freelancer.submit_work', task_id=t.id) }}">New Submission</a>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4">
                    <div class="text-center text-muted">
                        <div class="mb-2">No assignments yet.</div>
                        <div class="small">When an admin assigns you a task, it will appear here with a countdown to accept.</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="position-sticky" style="top: 1rem;">
            <div class="card mb-3">
                <div class="card-header"><strong>Guidelines</strong></div>
                <div class="card-body small">
                    <ul class="mb-2">
                        <li>Accept within the timer to secure the assignment.</li>
                        <li>Communicate blockers early via the task comments/email.</li>
                        <li>Submit drafts as a single ZIP or multiple files as needed.</li>
                        <li>We schedule a short client review before final delivery.</li>
                    </ul>
                    <div class="text-muted">All work is under NDA. Keep client data confidential.</div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Recent Submissions</strong>
                    <span class="small text-muted">Latest 8</span>
                </div>
                <div class="list-group list-group-flush">
                    {% set recent = [] %} {# Aggregate up to 8 most recent submissions across tasks (if relation is available) #} {% for a in assignments %} {% if a.task and a.task.work_submissions is defined and a.task.work_submissions %} {% for ws in a.task.work_submissions
                    %} {% set _ = recent.append({'task': a.task, 'ws': ws}) %} {% endfor %} {% endif %} {% endfor %} {% set recent = recent|sort(attribute='ws.submitted_at', reverse=True) %} {% for item in recent[:8] %}
                    <a class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#wsModal_{{ item.task.id }}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="fw-semibold">Task #{{ item.task.id }} — {{ item.task.title }}</div>
                                <div class="small text-muted">v{{ item.ws.version }} • {{ item.ws.submitted_at }}</div>
                            </div>
                            <span class="badge bg-light text-dark">Open</span>
                        </div>
                    </a>
                    {% else %}
                    <div class="list-group-item text-muted">No submissions yet.</div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <div class="card-header"><strong>Quick Links</strong></div>
                <div class="list-group list-group-flush">
                    <a class="list-group-item list-group-item-action" href="{{ url_for('freelancer.dashboard') }}">Refresh assignments</a>
                    <a class="list-group-item list-group-item-action" href="{{ url_for('client.dashboard') }}">View client-facing tasks</a>
                    <a class="list-group-item list-group-item-action" href="{{ url_for('freelancer.profile') }}">Edit profile</a>
                    <a class="list-group-item list-group-item-action" href="{{ url_for('freelancer.kyc') }}">
                        {% if current_user.kyc_status == 'approved' %}Update KYC{% else %}Verify identity (KYC){% endif %}
                    </a>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple filtering
    (function() {
        const search = document.getElementById('search');
        const statusFilter = document.getElementById('statusFilter');
        const table = document.getElementById('assignmentsTable');
        const countEl = document.getElementById('visibleCount');
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tbody tr'));

        function apply() {
            const q = (search && search.value || '').toLowerCase();
            const s = (statusFilter && statusFilter.value || '').toLowerCase();
            let visible = 0;
            rows.forEach(r => {
                const title = (r.getAttribute('data-title') || '').toLowerCase();
                const st = (r.getAttribute('data-status') || '').toLowerCase();
                const show = (!q || title.includes(q)) && (!s || st === s);
                r.style.display = show ? '' : 'none';
                if (show) visible++;
            });
            if (countEl) countEl.textContent = visible;
        }
        search && search.addEventListener('input', apply);
        statusFilter && statusFilter.addEventListener('change', apply);
        apply();
    })();

    // Acceptance countdown badges
    (function() {
        function pad(n) {
            return (n < 10 ? '0' : '') + n;
        }

        function tick() {
            const nodes = document.querySelectorAll('.countdown');
            const now = new Date();
            nodes.forEach(el => {
                const deadlineISO = el.getAttribute('data-deadline');
                if (!deadlineISO) return;
                const end = new Date(deadlineISO);
                const diff = end - now;
                if (diff <= 0) {
                    el.textContent = '00:00:00';
                    el.classList.remove('bg-warning');
                    el.classList.add('bg-dark');
                    return;
                }
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                el.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
            });
        }
        tick();
        setInterval(tick, 1000);
    })();
</script>

{% endblock %}